<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tunok’s Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --panel:#111827; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--fg); }
  header { padding:28px 20px; border-bottom:1px solid #1f2937; }
  main { padding:20px; display:grid; gap:20px; max-width:900px; margin:0 auto; }
  .card { background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; }
  h2 { margin:0 0 12px 0; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  select, button { background:#0f172a; color:var(--fg); border:1px solid #334155; border-radius:8px; padding:8px 10px; }
  button { cursor:pointer; }
  .pill { background:#0f172a; border:1px solid #334155; border-radius:999px; padding:6px 10px; color:var(--muted); }
  table { border-collapse:collapse; width:100%; margin-top:10px; }
  th, td { border-bottom:1px solid #1f2937; padding:6px 4px; text-align:left; }
  th { color:var(--muted); font-weight:600; }
  .muted { color:var(--muted); }
</style>
</head>
<body>
<header>
  <h1 style="margin:0">Tunok’s Lab</h1>
  <div class="muted">Playground for little experiments. Tell me where you’re from.</div>
</header>

<main>
  <section class="card">
    <h2>Where are you from?</h2>
    <div class="row">
      <div id="detected" class="pill">Detected: …</div>
      <select id="country"></select>
      <button id="reportBtn">Submit</button>
      <span id="feedback" class="pill" style="display:none"></span>
      <button id="refreshStats" style="margin-left:auto">Refresh stats</button>
    </div>
    <div id="stats"></div>
    <!-- World map with bubbles -->
    <div class="card" style="margin-top:16px">
      <h2>Visitors on the map</h2>
      <div id="mapWrap" style="
          position:relative;
          width:100%;
          max-width:860px;
          height:480px;
          border-radius:12px;
          overflow:hidden;
          border:1px solid #1f2937;
          background:#ffffff url('https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_blank_without_borders.svg') center/cover no-repeat;
        ">
        <canvas id="mapCanvas" width="860" height="480" style="
          position:absolute; inset:0; width:100%; height:100%;
        "></canvas>
        <div id="mapLegend" class="pill" style="position:absolute; right:8px; bottom:8px">Bubble size = visits</div>
        <div id="mapTooltip" style="position:absolute; padding:6px 8px; border-radius:8px; background:#111827; border:1px solid #334155; display:none; pointer-events:none"></div>
      </div>
    </div>

  </section>
</main>

<script>
const API = 'https://gitvisitstat.tunok-24.workers.dev'; // <-- your Worker URL

// Build a lightweight country list (expand anytime)
const CCODES = new Intl.DisplayNames(['en'], { type:'region' });
const COUNTRY_CODES = ['US','CA','GB','DE','FR','IN','CN','JP','KR','AU','BR','MX','ZA','NG','IT','ES','SE','NO','FI','NL','PL','TR','AE','SG','MY','ID','PH','VN','TH','TW','HK','NZ','AR','CL','CO','PE','BE','CH','AT','PT','IE','GR','DK','CZ','HU','RO','BG','UA','SK'];

const detectedEl = document.getElementById('detected');
const selectEl = document.getElementById('country');
const feedbackEl = document.getElementById('feedback');
const statsEl = document.getElementById('stats');

// Populate dropdown
selectEl.innerHTML = COUNTRY_CODES
  .sort((a,b)=>(CCODES.of(a)||a).localeCompare(CCODES.of(b)||b))
  .map(cc=>`<option value="${cc}">${CCODES.of(cc)||cc}</option>`).join('');

async function hit() {
  try {
    const r = await fetch(API + '/hit', { method:'POST' });
    const j = await r.json();
    detectedEl.textContent = 'Detected: ' + (CCODES.of(j.real)||j.real||'Unknown');
  } catch {
    detectedEl.textContent = 'Detected: (error)';
  }
}

async function report() {
  const cc = selectEl.value;
  const r = await fetch(API + '/selfreport?cc=' + encodeURIComponent(cc));
  const j = await r.json();
  if (!j.ok) return;
  feedbackEl.style.display = 'inline-block';
  if (j.mismatch) {
    feedbackEl.textContent = `Mismatch — you said ${CCODES.of(j.self)||j.self}, detected ${CCODES.of(j.real)||j.real}`;
    feedbackEl.style.background = '#3b0a0a';
    feedbackEl.style.color = '#fca5a5';
  } else {
    feedbackEl.textContent = `Match — ${CCODES.of(j.real)||j.real}`;
    feedbackEl.style.background = '#0a3b19';
    feedbackEl.style.color = '#86efac';
  }
  fetch(API + '/event?name=selfreport', { method:'POST' }).catch(()=>{});
  await loadStats();
}

async function loadStats() {
  const r = await fetch(API + '/stats');
  const { data } = await r.json();
  const top = Object.entries(data.cc || {}).sort((a,b)=>b[1]-a[1]).slice(0,20);
  const rows = top.map(([cc,n])=> `<tr><td>${CCODES.of(cc)||cc}</td><td>${n}</td></tr>`).join('');
  statsEl.innerHTML = `<table>
    <thead><tr><th>Country</th><th>Visits</th></tr></thead>
    <tbody>${rows || '<tr><td colspan="2" class="muted">No data yet</td></tr>'}</tbody>
  </table>`;
}

document.getElementById('reportBtn').addEventListener('click', report);
document.getElementById('refreshStats').addEventListener('click', loadStats);

(async function init(){
  await hit();       // increments + shows detected country
  await loadStats(); // builds the table
})();

/* --- simple equirectangular projection + centroids --- */
const MAP = {
  US:[-98.5,39.8], CA:[-106.3,56.1], MX:[-102.6,23.9], BR:[-51.9,-10.8], AR:[-64.2,-34.1],
  GB:[-1.6,52.4], IE:[-8.1,53.3], FR:[2.3,46.2], ES:[-3.7,40.3], PT:[-8.0,39.6], IT:[12.6,42.8],
  DE:[10.2,51.1], AT:[14.1,47.6], CH:[8.2,46.8], BE:[4.5,50.6], NL:[5.3,52.2], SE:[16.3,62.8], NO:[8.5,61.2], FI:[26.3,64.9], DK:[10.0,56.2],
  PL:[19.1,52.1], CZ:[15.3,49.8], SK:[19.5,48.7], HU:[19.1,47.2], RO:[24.8,45.9], BG:[25.2,42.7], GR:[22.9,39.1], UA:[31.2,49.0],
  TR:[35.2,39.0], RU:[105.3,61.5],
  AE:[54.3,24.3], SA:[45.0,24.0], EG:[29.9,26.8], ZA:[24.7,-29.0], NG:[8.1,9.6],
  IN:[79.1,22.4], CN:[104.2,35.9], JP:[138.0,37.7], KR:[127.8,36.4], TW:[121.0,23.7], HK:[114.1,22.3],
  SG:[103.8,1.35], MY:[102.3,4.2], ID:[113.9,-0.8], PH:[122.9,11.7], VN:[106.3,16.7], TH:[100.9,15.6],
  AU:[134.5,-25.7], NZ:[172.5,-41.8], CL:[-71.5,-35.7], CO:[-74.3,4.8], PE:[-75.0,-9.2]
};

const mapCanvas  = document.getElementById('mapCanvas');
const mapCtx     = mapCanvas.getContext('2d', { alpha: true });
const mapTooltip = document.getElementById('mapTooltip');
const mapWrap    = document.getElementById('mapWrap');

// helper: set canvas size to wrapper (keeps pixels sharp)
function sizeCanvasToWrap() {
  const w = Math.max(320, mapWrap.clientWidth | 0);
  const HtoW = 480/860; // keep same aspect as background
  const h = Math.round(w * HtoW);
  mapCanvas.width  = w;
  mapCanvas.height = h;
}

// project lon/lat to pixels (equirectangular)
function proj(lon, lat, W, H) {
  const x = (lon + 180) / 360 * W;
  const y = (90 - lat) / 180 * H;
  return [x, y];
}

function niceRadius(n, maxCount, W, H) {
  const rMax = Math.max(10, Math.min(W,H) * 0.05);
  if (maxCount <= 0) return 0;
  return 3 + Math.sqrt(n / maxCount) * (rMax - 3);
}

let lastBubbles = []; // for hover
function renderBubbles(ccCounts) {
  const W = mapCanvas.width, H = mapCanvas.height;
  mapCtx.clearRect(0,0,W,H);

  const entries = Object.entries(ccCounts).filter(([cc,n]) => MAP[cc] && n>0);
  const maxCount = entries.reduce((m,[,n]) => Math.max(m,n), 0);

  lastBubbles = entries.map(([cc, n]) => {
    const [lon, lat] = MAP[cc];
    const [x, y] = proj(lon, lat, W, H);
    const r = niceRadius(n, maxCount, W, H);
    return { cc, n, x, y, r };
  });

  // soft glow
  mapCtx.save();
  mapCtx.globalAlpha = 0.35;
  mapCtx.fillStyle = '#60a5fa';
  lastBubbles.forEach(b => { mapCtx.beginPath(); mapCtx.arc(b.x,b.y,b.r,0,Math.PI*2); mapCtx.fill(); });
  mapCtx.restore();

  // solid core
  mapCtx.save();
  mapCtx.globalAlpha = 0.9;
  mapCtx.fillStyle = '#93c5fd';
  mapCtx.strokeStyle = '#1f2937';
  mapCtx.lineWidth = 1.5;
  lastBubbles.forEach(b => {
    mapCtx.beginPath();
    mapCtx.arc(b.x, b.y, Math.max(3, b.r*0.7), 0, Math.PI*2);
    mapCtx.fill();
    mapCtx.stroke();
  });
  mapCtx.restore();
}

// override your existing loadStats to also draw bubbles
const _loadStatsOrig = loadStats;
loadStats = async function() {
  const r = await fetch(API + '/stats');
  const { data } = await r.json();

  // 1) keep your table
  const top = Object.entries(data.cc || {}).sort((a,b)=>b[1]-a[1]).slice(0,20);
  const rows = top.map(([cc,n])=> `<tr><td>${CCODES.of(cc)||cc}</td><td>${n}</td></tr>`).join('');
  statsEl.innerHTML = `<table>
    <thead><tr><th>Country</th><th>Visits</th></tr></thead>
    <tbody>${rows || '<tr><td colspan="2" class="muted">No data yet</td></tr>'}</tbody>
  </table>`;

  // 2) remember counts for future redraws (resize)
  window.__latestCC = data.cc || {};

  // 3) ensure canvas size is correct, then draw
  sizeCanvasToWrap();
  renderBubbles(window.__latestCC);
};

// hover tooltip
mapCanvas.addEventListener('mousemove', (e) => {
  if (!lastBubbles.length) return;
  const rect = mapCanvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (mapCanvas.width / rect.width);
  const y = (e.clientY - rect.top ) * (mapCanvas.height / rect.height);
  const hit = lastBubbles.find(b => (x-b.x)**2 + (y-b.y)**2 <= (b.r*1.1)**2);
  if (hit) {
    mapTooltip.style.display = 'block';
    mapTooltip.style.left = (e.clientX - rect.left + 12) + 'px';
    mapTooltip.style.top  = (e.clientY - rect.top  + 12) + 'px';
    mapTooltip.textContent = `${CCODES.of(hit.cc)||hit.cc}: ${hit.n}`;
  } else {
    mapTooltip.style.display = 'none';
  }
});

// resize observer to keep pixels sharp
new ResizeObserver(() => {
  sizeCanvasToWrap();
  renderBubbles(window.__latestCC || {});
}).observe(mapWrap);

// set initial canvas size once, in case stats load is slow
sizeCanvasToWrap();
  
</script>
</body>
</html>
